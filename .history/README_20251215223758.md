# Django

## Creating a Django Project

- When Creating a django project it is always important to create a virtual environment.

```python
python -m venv .venv
```

- After that it is important to install Django.

```python
python -m pip install Django  
```

- To create a django project we use the command.
  
```python
django-admin startproject smartnotes  
```

- To run the project you use the command.

```python
python manage.py runserver 
```

## Creating an App

- Due to the Django MVT/MVC Architecture, Django was trying to ensure that the wide projects is broken down into small apps.
- To create an app inside the Django project we use the command.

```python
django-admin startapp home
```

- home is the name of the app inside the smartnotes project
- The app is then defined in the INSTALLED_APPS array in the settings.py

```python
INSTALLED_APPS = [
    .
    .
    .
    
    # Apps
    'home',
]
```

- Now in the home app, we go to the views.py file and import HttpResponse from django.http.
- Then define the functions in the view

```python
from django.http import HttpResponse

def home(request):
    return HttpResponse("Hello World")
```

- Now in the project under urls.py we need to define a path to that view.

```python
from django.contrib import admin
from django.urls import path
from home import views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('home', views.home)
]
```

![alt text](image.png)

## The MVT framework

- Django uses Model View Template framework.

![alt text](image-1.png)

- Model - Handles Data.
- View - Responsible for handling request and responses.
- Template - Allow us to render data into html pages.

## Template pages

- To use the .html page files one creates a template folder inside the app and inside the template folder you create another folder with the name of the app.
- Now of the views.py, you can render the pages correctly.

```python
def welcome(request):
    return render(request, "home/welcome.html", {'today': datetime.today()}) 
```

- urls.py

```python
from django.contrib import admin
from django.urls import path
from home import views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('home', views.home),
    path('', views.welcome)
]

```

![alt text](image-3.png)

## Cleaning the Project Structure

- In order to ensure that if the home app is not interdependent with the project, we will create urls.py file in the home app.
- Then we will include the path only in the project urls.py
- home/urls.py

```python
from django.urls import path
from . import views

urlpatterns = [
    path('home', views.home),
    path('', views.welcome)
]
```

- urls.py

```python
from django.contrib import admin
from django.urls import path, include


urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include("home.urls"))
]

```

- That ensures that the project is well Organized.

## Migrations

- Whenever there are changes in the database Django always say that there are migrations that need to be done. This is important since it fully updates the database.
- We do this by using the command

```python
python manage.py migrate
```

![alt text](image-4.png)

## Creating Django Admin SuperUser

- In order to be able to login to the admin Dashboard that comes by default in Django, we need to create a Super User

```python
python manage.py createsuperuser  
```

- Output

```python                                                        smartnotes 04:33:16
Username (leave blank to use 'josephmbote'): mbote
Email address: mbotejoseph001@gmail.com
Password: 
Password (again): 
Superuser created successfully.
```

## Adding Authorization to a view

- If we want to restrict specific pages to only the logged in users, Django has a way that it have implemented it in a simple way.
- In views.py in the app where the page is being rendered. we import the login_required decorator and then add the decorator on top of the view functions

```python
from django.shortcuts import render
from django.contrib.auth.decorators import login_required

book = {
        "name": "Think Big",
        "Author": "Ben Carson",
        "year": 2020,
        "Genre": "Motivation"
    }
# Create your views here.
@login_required(login_url='/admin')
def books(request):
    return render(request, "books/index.html", {'books' : book})
```

## Django ORM

- In Django we create our own models.
- Django uses Object Relation Mapping which allow us to create our models which we can migrate to databases to allow communication.

![alt text](image-5.png)

- The way we transform a Model into a Database table is by the creation of the migrations. We can also use makemigrations the way we use migrate.

![alt text](image-7.png)

## Creating models

- We start by creating the app where we want to create the models
- Then on the apps, models.py we create a model

```python
from django.db import models

# Create your models here.
class Notes(models.Model):
    title = models.CharField(max_length=200)
    text = models.TextField()
    created = models.DateTimeField(auto_now_add=True)
```

- From there we need to makemigrations

```python
python manage.py makemigrations
```

- From there we need now to migrate

```python
python manage.py migrate
```

![alt text](image-8.png)

- In order to make it possible to display the Tables from the models that were created, we need to go to the admin.py in the app and import that model

```python
from django.contrib import admin

from . import models

# Register your models here.
class NotesAdmin(admin.ModelAdmin):
    list_display = ('title',)

admin.site.register(models.Notes, NotesAdmin)
```

## Class-based views

- Class-based Views helps us create powerful endpoints without too much effort.

```python
from django.shortcuts import render
from django.http import HttpResponse
from datetime import datetime
from django.views.generic import TemplateView
from django.contrib.auth.mixins import LoginRequiredMixin

# Create your views here.
# def home(request):
#     return HttpResponse('Hello, World!')

class HomeView(LoginRequiredMixin, TemplateView):
    template_name = "home/welcome.html"
    login_url = "/admin"

# def welcome(request):
#     return render(request, "home/welcome.html", {'today': datetime.today()})

class WelcomeView(TemplateView):
    template_name = "home/welcome.html"
    extra_context = {'today': datetime.today()}
```

```python
from django.shortcuts import render
from django.contrib.auth.mixins import LoginRequiredMixin
from django.http import Http404
from django.views.generic import ListView, DetailView

from .models import Books

class BooksListView(LoginRequiredMixin, ListView):
    model = Books
    context_object_name = "books"
    login_url = "/admin"
    template_name = "books/index.html"


class BookDetailsView(DetailView):
    model = Books
    context_object_name = "book"
    template_name = "books/book.html"

```

## Django Forms

![alt text](image-9.png)

## Cross-Site Request Forgery

![alt text](image-11.png)

- After sending the request it needs to confirm that this request is coming from a legit users. It will process the request and submit.

![alt text](image-12.png)

- If the request is comming from illigetimate site it denies the permission.

![alt text](image-10.png)

## Authorization and pulling data for the logged in users

![alt text](image-13.png)

![alt text](image-14.png)

- Trying to submit without the logged in user

![alt text](image-15.png)

- So we make sure we take the data of the user who is logged in

![alt text](image-16.png)

## Custom Login in Django

```python
from django.shortcuts import render
from django.http import HttpResponse
from datetime import datetime
from django.views.generic import TemplateView
from django.contrib.auth.mixins import LoginRequiredMixin
from django.contrib.auth.views import LoginView, LogoutView

class CustomLoginView(LoginView):
    template_name = "home/login.html"
    redirect_authenticated_user = True

class CustomLogoutView(LogoutView):
    template_name = "home/logout.html"
    
    
    
# Create your views here.
# def home(request):
#     return HttpResponse('Hello, World!')

class HomeView(LoginRequiredMixin, TemplateView):
    template_name = "home/welcome.html"
    login_url = "/login"

# def welcome(request):
#     return render(request, "home/welcome.html", {'today': datetime.today()})

class WelcomeView(TemplateView):
    template_name = "home/welcome.html"
    extra_context = {'today': datetime.today()}
```

```python
from django.urls import path
from . import views

urlpatterns = [
    path('home', views.HomeView.as_view(), name='home'),
    path('', views.WelcomeView.as_view(), name='welcome'),
    path('login', views.CustomLoginView.as_view(), name='login'),
    path('logout', views.CustomLogoutView.as_view(), name='logout'),
]
 
```

```python
{% extends 'base.html' %}

{% block content %}
    <div class="container mt-4 col-sm-6 mb-3 mb-sm-0">
        <h2>Login</h2>
        <form method="post" >
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
    </div>
{% endblock %}
```

```python
{% extends 'base.html' %}


{% block content %}
    <div class="container mt-4 col-sm-6 mb-3 mb-sm-0">
        <h2> You are Logout out !!</h2>
        
    </div>
{% endblock %}

```

- Settings.py configs

```python
# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    .
    .
    .
    
    # Apps
    'home',
    'books',
    'notes',
]



ROOT_URLCONF = 'smartnotes.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [
            BASE_DIR / 'static/templates'
            ],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'smartnotes.wsgi.application'


# Database
# https://docs.djangoproject.com/en/6.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

.
.
.

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/6.0/howto/static-files/

STATIC_URL = '/static/'
STATICFILES_DIRS = (
  os.path.join(BASE_DIR, 'static/'),
)


LOGIN_REDIRECT_URL = '/home'

IS_CODESPACES = os.environ.get('CODESPACES') == 'true'
if IS_CODESPACES:
    CSRF_TRUSTED_ORIGINS = ['https://localhost:8000', 'https://*.githubpreview.dev']
```

### Searching Globally

- views.py

```python
from django.apps import apps
from django.db.models import Q
from django.shortcuts import render

# Which field types to search (text-like)
SEARCH_FIELD_TYPES = {"CharField", "TextField", "EmailField", "SlugField", "URLField"}

# Optional: exclude noisy/internal apps
EXCLUDED_APPS = {"admin", "auth", "contenttypes", "sessions", "messages", "staticfiles"}

# Optional: exclude specific models you donâ€™t want searchable
EXCLUDED_MODELS = {("yourapp", "SomelogModel")}  # example: ("logs", "AuditLog")


def global_search(request):
    query = (request.GET.get("q") or "").strip()
    results = []  # list of dicts: {label, model, items}

    if not query:
        return render(request, "search/results.html", {"query": query, "results": results})

    for model in apps.get_models():
        app_label = model._meta.app_label
        model_name = model.__name__

        if app_label in EXCLUDED_APPS:
            continue
        if (app_label, model_name) in EXCLUDED_MODELS:
            continue

        # Collect searchable fields
        searchable_fields = []
        for f in model._meta.get_fields():
            # skip relations
            if getattr(f, "many_to_many", False) or getattr(f, "one_to_many", False) or getattr(f, "is_relation", False):
                continue
            internal_type = f.get_internal_type()
            if internal_type in SEARCH_FIELD_TYPES:
                searchable_fields.append(f.name)

        if not searchable_fields:
            continue

        # Build OR query across those fields
        q_obj = Q()
        for field_name in searchable_fields:
            q_obj |= Q(**{f"{field_name}__icontains": query})

        qs = model.objects.filter(q_obj).distinct()[:10]  # limit per model

        if qs.exists():
            results.append({
                "label": f"{app_label}.{model_name}",
                "model": model,
                "items": qs
            })

    return render(request, "search/results.html", {"query": query, "results": results})
```

## Url for search

```python
from django.urls import path
from .views import global_search

urlpatterns = [
    path("search/", global_search, name="global_search"),
]
```

## Navbar Search

```python
<form class="d-flex" method="GET" action="{% url 'global_search' %}">
  <input class="form-control me-2" type="search" name="q" placeholder="Search everything..." required>
  <button class="btn btn-outline-success" type="submit">Search</button>
</form>
```

## Results Template (templates/search/results.html)

```python
{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <h3>Search Results for "{{ query }}"</h3>

  {% if results %}
    {% for group in results %}
      <div class="mt-4">
        <h5 class="text-muted">{{ group.label }}</h5>
        <ul class="list-group">
          {% for obj in group.items %}
            <li class="list-group-item">{{ obj }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted mt-3">No results found.</p>
  {% endif %}
</div>
{% endblock %}

```

- This uses {{ obj }} so make sure each model has a good __str__().
